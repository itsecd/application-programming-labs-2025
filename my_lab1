import argparse
import re


def parse_arguments() -> argparse.Namespace:
    """
    Добавляет аргументы из командной строки
    """
    parser = argparse.ArgumentParser()
    parser.add_argument("filename", help="File to search in")
    parser.add_argument("--output", "-o", help="File to save in search result")
    return parser.parse_args()


def read_file(path: str) -> str:
    """
    Читает файл
    """
    try:
        with open(path, "r", encoding="utf-8") as file:
            return file.read()
    except FileNotFoundError:
        raise FileNotFoundError("Error: this file is not found")
    except PermissionError:
        raise PermissionError("Недостаточно прав")


def write_in_file(path: str, data: list[str]) -> None:
    """
    Записывает что-то в файл
    """
    try:
        with open(path, "w", encoding="utf-8") as file:
            file.write("\n\n".join(data))
    except:
        print("Error: this file is not found")


def split_candidates(data: str) -> list[str]:
    """
    Разделяет файл на список кондидатов
    """
    candidates = re.split(r"\n{2}", data)
    return candidates


def find_candidates(candidates: list[str], code: int) -> list[str]:
    """
    Ищет кандидатов по номеру телефона:

    """
    found_candidates = []
    pattern = r"^(\+7|8)\s?(\(\d{3}\)|\d{3})\s?\d{3}[-\s]?\d{2}[-\s]?\d{2}$"

    for candidate in candidates:
        match = re.search(r"Номер телефона или email:\s*(.*)", candidate)
        if not match:
            continue
        valid_number = match.group(1).strip()
        if re.fullmatch(pattern, valid_number):
            simple_code = re.sub(r"\D", "", valid_number)
            city_code = simple_code[1:4]
            if city_code == code:
                found_candidates.append(candidate)

    return found_candidates


def main():
    try:
        args = parse_arguments()
        data = read_file(args.filename)
        candidates = split_candidates(data)
        fulfilling_candidates = find_candidates(candidates, "927")
        if fulfilling_candidates:
            for item in fulfilling_candidates:
                print(item)
            print(f"Number of fulfilling candidates: {len(fulfilling_candidates)}")
            if args.output:
                write_in_file(args.output, fulfilling_candidates)
                print(f"Successfully write output to: {args.output}")
        else:
            print("No fulfilling candidates!")

    except Exception:
        print("Something wrong happend")


if __name__ == "__main__":
    main()
